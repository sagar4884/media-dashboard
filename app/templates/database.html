<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div class="min-h-screen">
        {% include 'header.html' %}
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <h2 class="text-3xl font-bold leading-tight text-white">Database Management</h2>
            <p class="mt-2 text-gray-400">Manage and maintain the application's database.</p>

            <div class="mt-6 bg-gray-800 p-4 rounded-lg shadow-xl">
                <h3 class="text-xl font-semibold text-white">Database Information</h3>
                <div class="mt-4">
                    <p><strong>Type:</strong> {{ db_info.type }}</p>
                    <p><strong>Path:</strong> {{ db_info.path }}</p>
                    <p><strong>Size:</strong> {{ "%.2f"|format(db_info.size_mb) }} MB</p>
                </div>
            </div>

            <div class="mt-6 bg-gray-800 p-4 rounded-lg shadow-xl">
                <h3 class="text-xl font-semibold text-white">Database Actions</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <h5 class="font-semibold">Integrity Check</h5>
                        <p class="text-gray-400">Verify the integrity of the database file. Checks for corruption.</p>
                        <button class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm font-medium" onclick="performAction('/database/integrity_check', 'integrity-result')">Run Integrity Check</button>
                        <pre id="integrity-result" class="mt-2 p-2 bg-gray-900 border border-gray-700 rounded" style="display: none;"></pre>
                    </div>
                    <hr class="border-gray-700">
                    <div>
                        <h5 class="font-semibold">Optimize Database</h5>
                        <p class="text-gray-400">Run the OPTIMIZE command to reclaim unused space and defragment the database.</p>
                        <button class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm font-medium" onclick="performAction('/database/optimize', 'optimize-result')">Optimize Database</button>
                        <pre id="optimize-result" class="mt-2 p-2 bg-gray-900 border border-gray-700 rounded" style="display: none;"></pre>
                    </div>
                    <hr class="border-gray-700">
                    <div>
                        <h5 class="font-semibold">Vacuum Database</h5>
                        <p class="text-gray-400">Rebuild the entire database to reclaim space from deleted data. This can take a while and will lock the database.</p>
                        <button class="mt-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-md text-sm font-medium" onclick="startBackgroundTask('/database/vacuum', 'vacuum-status')">Vacuum Database</button>
                        <div id="vacuum-status" class="mt-2" style="display: none;">
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%;"></div>
                            </div>
                            <p class="mt-2 text-sm text-gray-400">Status: <span class="status-text">Starting...</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    function performAction(url, resultElementId) {
        const resultElement = document.getElementById(resultElementId);
        resultElement.style.display = 'block';
        resultElement.textContent = 'Running...';

        fetch(url, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                resultElement.textContent = data;
            })
            .catch(error => {
                console.error('Error:', error);
                resultElement.textContent = 'An error occurred.';
            });
    }

    function startBackgroundTask(url, statusElementId) {
        const statusElement = document.getElementById(statusElementId);
        statusElement.style.display = 'block';

        const progressBar = statusElement.querySelector('.bg-blue-600');
        const statusText = statusElement.querySelector('.status-text');

        fetch(url, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                const jobId = data.job_id;
                statusText.textContent = 'Task started...';

                const interval = setInterval(() => {
                    fetch(`/task_status/${jobId}`)
                        .then(response => response.json())
                        .then(job => {
                            if (job.status === 'finished') {
                                clearInterval(interval);
                                progressBar.style.width = '100%';
                                progressBar.classList.remove('bg-blue-600');
                                progressBar.classList.add('bg-green-600');
                                statusText.textContent = 'Completed!';
                            } else if (job.status === 'failed') {
                                clearInterval(interval);
                                progressBar.classList.remove('bg-blue-600');
                                progressBar.classList.add('bg-red-600');
                                statusText.textContent = 'Task failed!';
                            } else {
                                const progress = job.progress || 0;
                                progressBar.style.width = progress + '%';
                                statusText.textContent = job.status + ' (' + progress + '%)';
                            }
                        })
                        .catch(error => {
                            clearInterval(interval);
                            console.error('Error fetching task status:', error);
                            statusText.textContent = 'Error fetching status.';
                        });
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = 'Failed to start the task.';
            });
    }
    </script>
</body>
</html>

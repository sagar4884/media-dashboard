<!-- Sticky Header -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<header class="sticky top-0 bg-gray-800/50 backdrop-blur-md shadow-lg z-10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <a href="{{ url_for('dashboard') }}" class="text-2xl font-bold text-white">Media Dashboard</a>
            <nav class="flex items-center space-x-4">
                <a href="{{ url_for('radarr_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Radarr</a>
                <a href="{{ url_for('sonarr_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Sonarr</a>
                <a href="{{ url_for('tautulli_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Tautulli</a>
                <a href="{{ url_for('seasonal_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Seasonal</a>
                <a href="{{ url_for('overlays_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Overlays</a>
                <a href="{{ url_for('deletion_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Deletion Manager</a>
                <a href="{{ url_for('database_page') }}" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Database</a>
                <a href="{{ url_for('settings') }}" class="flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8 7.45M7.45 8L3.17 8.51c-1.56.38-1.56 2.6 0 2.98L7.45 12M8 12.55l-.51 4.28c-.38 1.56 2.6 1.56 2.98 0L12 12.55M12.55 12l4.28-.51c1.56-.38 1.56-2.6 0-2.98L12.55 8M10 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zM10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" clip-rule="evenodd" /></svg>
                    Settings
                </a>
            </nav>
        </div>
    </div>
</header>

<!-- Global Job ID Holder -->
<div id="global-job-id" data-job-id="{{ active_job_id or 'None' }}" style="display: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Handle Flash Messages as Toasts
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                Toastify({
                    text: "{{ message }}",
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "{{ 'linear-gradient(to right, #00b09b, #96c93d)' if category == 'success' else 'linear-gradient(to right, #ff5f6d, #ffc371)' }}",
                    stopOnFocus: true
                }).showToast();
            {% endfor %}
        {% endif %}
        {% endwith %}

        // 2. Global Job Polling
        const jobElement = document.getElementById('global-job-id');
        let activeJobId = jobElement.dataset.jobId;
        let pollingInterval = null;
        let progressToast = null;

        function disableSyncButtons() {
            const buttons = document.querySelectorAll('.sync-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerText;
                btn.innerText = 'Syncing...';
            });
        }

        function enableSyncButtons() {
            const buttons = document.querySelectorAll('.sync-btn');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                if (btn.dataset.originalText) btn.innerText = btn.dataset.originalText;
            });
        }

        function startGlobalPolling(jobId) {
            if (pollingInterval) clearInterval(pollingInterval);
            
            disableSyncButtons();

            // Create sticky toast if not exists
            if (!progressToast) {
                progressToast = Toastify({
                    text: "Background Task Running...",
                    duration: -1, // Persistent
                    close: false,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "#2d3748", // Gray-800
                    className: "progress-toast",
                    escapeMarkup: false
                }).showToast();
            }

            pollingInterval = setInterval(() => {
                fetch('/task_status/' + jobId)
                    .then(response => response.json())
                    .then(data => {
                        // Update Toast Content
                        const progress = data.progress || 0;
                        const eta = data.eta || 'Calculating...';
                        
                        // We need to update the toast DOM directly since Toastify doesn't have an update method
                        // This is a bit hacky but works. Better would be to close and reopen or use a custom node.
                        const toastElement = document.querySelector('.progress-toast');
                        if (toastElement) {
                            toastElement.innerHTML = `
                                <div class="flex flex-col min-w-[250px]">
                                    <div class="flex justify-between mb-1">
                                        <span class="font-bold text-sm">Syncing...</span>
                                        <span class="text-xs text-gray-300">${eta}</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="mt-2 text-right">
                                        <button onclick="stopJob()" class="text-xs text-red-400 hover:text-red-300">Stop</button>
                                    </div>
                                </div>
                            `;
                        }

                        if (data.status === 'finished' || data.status === 'failed') {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                            enableSyncButtons();
                            
                            // Close progress toast
                            const toastInstance = progressToast; // Reference to close
                            // Toastify doesn't expose a clean .hide() on the instance easily in all versions, 
                            // but we can remove the element or let it expire if we set duration.
                            // Since we set duration -1, we must remove it.
                            if (toastElement) toastElement.remove();
                            progressToast = null;

                            if (data.status === 'finished') {
                                Toastify({
                                    text: "Task Completed Successfully!",
                                    duration: 3000,
                                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                                }).showToast();
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                Toastify({
                                    text: "Task Failed!",
                                    duration: 5000,
                                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                                }).showToast();
                            }
                        }
                    })
                    .catch(err => {
                        console.error("Polling error:", err);
                        clearInterval(pollingInterval);
                        enableSyncButtons();
                    });
            }, 2000);
        }

        // Start if job exists on load
        if (activeJobId && activeJobId !== 'None') {
            startGlobalPolling(activeJobId);
        }

        // Listen for HTMX events (when a sync button is clicked)
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.job_id) {
                    startGlobalPolling(response.job_id);
                }
            } catch (e) {
                // Ignore non-JSON responses
            }
        });

        // Global Stop Job Function
        window.stopJob = function() {
            fetch('/stop-job', { method: 'POST' })
                .then(() => {
                    Toastify({
                        text: "Stopping task...",
                        duration: 2000,
                        backgroundColor: "#4a5568"
                    }).showToast();
                });
        };
    });
</script>
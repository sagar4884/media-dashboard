<!-- Sticky Header -->
<header class="sticky top-0 glass-header z-50" x-data="{ mobileMenuOpen: false }">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <a href="{{ url_for('main.dashboard') }}" class="text-2xl font-bold text-white">Media Dashboard</a>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center space-x-4">
                <a href="{{ url_for('radarr.radarr_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'radarr.radarr_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Radarr</a>
                <a href="{{ url_for('sonarr.sonarr_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'sonarr.sonarr_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Sonarr</a>
                <a href="{{ url_for('tautulli.tautulli_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'tautulli.tautulli_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Tautulli</a>
                <a href="{{ url_for('sonarr.seasonal_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'sonarr.seasonal_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Seasonal</a>
                <a href="{{ url_for('ai.ai_dashboard') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'ai.ai_dashboard' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">AI Curator</a>
                <a href="{{ url_for('radarr.overlays_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'radarr.overlays_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Overlays</a>
                <a href="{{ url_for('deletion.deletion_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'deletion.deletion_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Deletion Manager</a>
                <a href="{{ url_for('logs.index') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'logs.index' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Logs</a>
                <a href="{{ url_for('settings.database_page') }}" class="px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'settings.database_page' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Database</a>
                <a href="{{ url_for('settings.settings') }}" class="flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors {% if request.endpoint == 'settings.settings' %}bg-white/10 text-white shadow-sm border border-white/10{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8 7.45M7.45 8L3.17 8.51c-1.56.38-1.56 2.6 0 2.98L7.45 12M8 12.55l-.51 4.28c-.38 1.56 2.6 1.56 2.98 0L12 12.55M12.55 12l4.28-.51c1.56-.38 1.56-2.6 0-2.98L12.55 8M10 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zM10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" clip-rule="evenodd" /></svg>
                    Settings
                </a>
            </nav>

            <!-- Mobile Menu Button -->
            <div class="md:hidden flex items-center">
                <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="text-gray-300 hover:text-white focus:outline-none focus:text-white transition-transform active:scale-95 cursor-pointer" aria-label="Toggle menu">
                    <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                        <path :class="{'hidden': mobileMenuOpen, 'inline-flex': !mobileMenuOpen }" class="inline-flex" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        <path :class="{'hidden': !mobileMenuOpen, 'inline-flex': mobileMenuOpen }" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div x-show="mobileMenuOpen" 
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 -translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-2"
         class="md:hidden bg-gray-900/95 backdrop-blur-xl border-t border-white/10 absolute w-full left-0 z-50 shadow-xl">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="{{ url_for('radarr.radarr_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'radarr.radarr_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Radarr</a>
            <a href="{{ url_for('sonarr.sonarr_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'sonarr.sonarr_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Sonarr</a>
            <a href="{{ url_for('tautulli.tautulli_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'tautulli.tautulli_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Tautulli</a>
            <a href="{{ url_for('sonarr.seasonal_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'sonarr.seasonal_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Seasonal</a>
            <a href="{{ url_for('ai.ai_dashboard') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'ai.ai_dashboard' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">AI Curator</a>
            <a href="{{ url_for('radarr.overlays_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'radarr.overlays_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Overlays</a>
            <a href="{{ url_for('deletion.deletion_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'deletion.deletion_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Deletion Manager</a>
            <a href="{{ url_for('logs.index') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'logs.index' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Logs</a>
            <a href="{{ url_for('settings.database_page') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'settings.database_page' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Database</a>
            <a href="{{ url_for('settings.settings') }}" class="block px-3 py-2 rounded-md text-base font-medium transition-all active:scale-95 {% if request.endpoint == 'settings.settings' %}bg-white/10 text-white{% else %}text-gray-300 hover:bg-white/5 hover:text-white{% endif %}">Settings</a>
        </div>
    </div>
</header>

<!-- Scroll to Top Button -->
<button id="scroll-to-top" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 translate-y-10 z-40" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
</button>

<!-- Global Job ID Holder -->
<div id="global-job-id" data-job-id="{{ active_job_id or 'None' }}" style="display: none;"></div>

<!-- Global Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-white/10">
                <div class="bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-900/30 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-white" id="modal-title">Confirm Action</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-300" id="modal-message">Are you sure you want to proceed?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-700/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="modal-confirm-btn" class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-colors">Confirm</button>
                    <button type="button" id="modal-cancel-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-gray-300 shadow-sm ring-1 ring-inset ring-gray-600 hover:bg-white/20 sm:mt-0 sm:w-auto transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Handle Flash Messages as Toasts
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                Toastify({
                    text: "{{ message }}",
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "{{ 'linear-gradient(to right, #00b09b, #96c93d)' if category == 'success' else 'linear-gradient(to right, #ff5f6d, #ffc371)' }}",
                    stopOnFocus: true
                }).showToast();
            {% endfor %}
        {% endif %}
        {% endwith %}

        // 2. Global Job Polling
        const jobElement = document.getElementById('global-job-id');
        let activeJobId = jobElement.dataset.jobId;
        let pollingInterval = null;
        let progressToast = null;

        function disableSyncButtons() {
            const buttons = document.querySelectorAll('.sync-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerText;
                btn.innerText = btn.dataset.loadingText || 'Processing...';
            });
        }

        function getJobDescription(funcName) {
            if (!funcName) return 'Processing...';
            if (funcName.includes('sync_radarr')) return 'Syncing Radarr';
            if (funcName.includes('sync_sonarr')) return 'Syncing Sonarr';
            if (funcName.includes('sync_tautulli')) return 'Syncing Tautulli';
            if (funcName.includes('learn_user')) return 'Analyzing Library';
            if (funcName.includes('score_media')) return 'Scoring Media';
            return 'Processing...';
        }

        function enableSyncButtons() {
            const buttons = document.querySelectorAll('.sync-btn');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                if (btn.dataset.originalText) btn.innerText = btn.dataset.originalText;
            });
        }

        function startGlobalPolling(jobId) {
            if (pollingInterval) clearInterval(pollingInterval);
            
            disableSyncButtons();

            // Create sticky toast if not exists
            if (!progressToast) {
                progressToast = Toastify({
                    text: "Starting Task...",
                    duration: -1, // Persistent
                    close: false,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "#2d3748", // Gray-800
                    className: "progress-toast",
                    escapeMarkup: false
                }).showToast();
            }

            pollingInterval = setInterval(() => {
                fetch('/task_status/' + jobId)
                    .then(response => response.json())
                    .then(data => {
                        // Update Toast Content
                        const progress = data.progress || 0;
                        const eta = data.eta || 'Calculating...';
                        const description = getJobDescription(data.func_name);
                        
                        // We need to update the toast DOM directly since Toastify doesn't have an update method
                        // This is a bit hacky but works. Better would be to close and reopen or use a custom node.
                        const toastElement = document.querySelector('.progress-toast');
                        if (toastElement) {
                            toastElement.innerHTML = `
                                <div class="flex flex-col min-w-[250px]">
                                    <div class="flex justify-between mb-1">
                                        <span class="font-bold text-sm">${description}</span>
                                        <span class="text-xs text-gray-300">${eta}</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="mt-2 text-right">
                                        <button onclick="stopJob()" class="text-xs text-red-400 hover:text-red-300">Stop</button>
                                    </div>
                                </div>
                            `;
                        }

                        if (data.status === 'finished' || data.status === 'failed') {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                            enableSyncButtons();
                            
                            // Close progress toast
                            const toastInstance = progressToast; // Reference to close
                            // Toastify doesn't expose a clean .hide() on the instance easily in all versions, 
                            // but we can remove the element or let it expire if we set duration.
                            // Since we set duration -1, we must remove it.
                            if (toastElement) toastElement.remove();
                            progressToast = null;

                            if (data.status === 'finished') {
                                Toastify({
                                    text: "Task Completed Successfully!",
                                    duration: 3000,
                                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                                }).showToast();
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                Toastify({
                                    text: "Task Failed!",
                                    duration: 5000,
                                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                                }).showToast();
                            }
                        }
                    })
                    .catch(err => {
                        console.error("Polling error:", err);
                        clearInterval(pollingInterval);
                        enableSyncButtons();
                    });
            }, 2000);
        }

        // Start if job exists on load
        if (activeJobId && activeJobId !== 'None') {
            startGlobalPolling(activeJobId);
        }

        // Listen for HTMX events (when a sync button is clicked)
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.job_id) {
                    startGlobalPolling(response.job_id);
                }
            } catch (e) {
                // Ignore non-JSON responses
            }
        });

        // Global Stop Job Function
        window.stopJob = function() {
            fetch('/stop-job', { method: 'POST' })
                .then(() => {
                    Toastify({
                        text: "Stopping task...",
                        duration: 2000,
                        backgroundColor: "#4a5568"
                    }).showToast();
                });
        };

        // Global Confirmation Helper
        window.confirmAction = function(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmation-modal');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.remove('hidden');

                const close = (result) => {
                    modal.classList.add('hidden');
                    // Remove listeners to prevent memory leaks/multiple firings
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(result);
                };

                const onConfirm = () => close(true);
                const onCancel = () => close(false);

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
            });
        };

        // Scroll to Top Button
        const scrollBtn = document.getElementById('scroll-to-top');
        if (scrollBtn) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollBtn.classList.remove('opacity-0', 'translate-y-10');
                } else {
                    scrollBtn.classList.add('opacity-0', 'translate-y-10');
                }
            });
            scrollBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    });
</script>
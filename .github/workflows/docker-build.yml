name: Docker Image CI/CD

on:
  # This workflow is triggered when code is pushed to 'main' or 'beta' branches
  push:
    branches:
      - main
      - beta
      
env:
  # Define the full Docker image name once (replace with your details)
  DOCKER_IMAGE: bladelight/media-dashboard # Example: your-username/your-repo-name

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        # Buildx is a component that enables powerful build capabilities (like multi-arch builds)
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ”‘ Login to Docker Hub
        # Uses the secrets you created earlier for secure authentication
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ·ï¸ Define Image Tags
        id: meta
        # This step determines the correct tag based on the branch name
        run: |
          # Initialize the TAGS array
          TAGS=()
          
          # 1. Add the branch-specific tag (latest or beta)
          if [ "${{ github.ref_name }}" == "main" ]; then
            TAGS+=("${{ env.DOCKER_IMAGE }}:latest")
          elif [ "${{ github.ref_name }}" == "beta" ]; then
            TAGS+=("${{ env.DOCKER_IMAGE }}:beta")
          fi
          
          # 2. Add tag with the short commit SHA for traceability
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TAGS+=("${{ env.DOCKER_IMAGE }}:$SHORT_SHA")

          # 3. Join the array elements with a comma and set as output
          # This is the critical line that fixes the 'invalid reference format' error
          echo "tags=$(IFS=, ; echo "${TAGS[*]}")" >> $GITHUB_OUTPUT
          
      - name: ðŸ“¦ Build and Push Docker image
        # This action builds the image and pushes it to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: . # Assumes your Dockerfile is in the root directory
          push: true
          # The input expects comma-separated values, which we now provide
          tags: ${{ steps.meta.outputs.tags }}
          # Optional: Enable caching for faster subsequent builds
          cache-from: type=gha
          cache-to: type=gha,mode=max
